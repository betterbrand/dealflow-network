name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [22.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 9
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'pnpm'
    
    - name: Install dependencies
      run: pnpm install
    
    - name: Run TypeScript type checking
      run: pnpm exec tsc --noEmit

    - name: Sync database schema (add new columns and tables)
      run: |
        # Extract DB connection info from DATABASE_URL
        # Run ALTER TABLE statements - ignore errors if columns already exist
        node -e "
          const mysql = require('mysql2/promise');
          const url = new URL(process.env.DATABASE_URL);
          async function run() {
            const conn = await mysql.createConnection({
              host: url.hostname,
              port: url.port || 3306,
              user: url.username,
              password: url.password,
              database: url.pathname.slice(1),
              ssl: { rejectUnauthorized: false }
            });

            // Add columns to contacts table
            const columns = [
              'followers int', 'connections int', 'bannerImageUrl text',
              'firstName varchar(100)', 'lastName varchar(100)', 'bioLinks text',
              'posts text', 'activity text', 'peopleAlsoViewed text',
              'linkedinId varchar(100)', 'linkedinNumId varchar(100)',
              'city varchar(255)', 'countryCode varchar(10)',
              'memorializedAccount int DEFAULT 0', 'educationDetails text',
              'honorsAndAwards text', 'lastEnrichedAt timestamp',
              'enrichmentSource varchar(50)',
              'lastImportedAt timestamp', 'importSource varchar(50)',
              'importStatus varchar(50)', 'opportunity text'
            ];
            for (const col of columns) {
              const name = col.split(' ')[0];
              try {
                await conn.execute('ALTER TABLE contacts ADD ' + col);
                console.log('Added column:', name);
              } catch (e) {
                if (e.code === 'ER_DUP_FIELDNAME') console.log('Column exists:', name);
                else throw e;
              }
            }

            // Create rdfTriples table if not exists
            try {
              await conn.execute(\`
                CREATE TABLE IF NOT EXISTS rdfTriples (
                  id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                  subject VARCHAR(512) NOT NULL,
                  predicate VARCHAR(512) NOT NULL,
                  object TEXT NOT NULL,
                  objectType VARCHAR(20) NOT NULL,
                  contactId INT NULL,
                  createdAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                  INDEX idx_rdf_subject (subject),
                  INDEX idx_rdf_predicate (predicate),
                  INDEX idx_rdf_contact (contactId),
                  FOREIGN KEY (contactId) REFERENCES contacts(id) ON DELETE CASCADE
                )
              \`);
              console.log('Created table: rdfTriples');
            } catch (e) {
              if (e.code === 'ER_TABLE_EXISTS_ERROR') console.log('Table exists: rdfTriples');
              else throw e;
            }

            await conn.end();
          }
          run().catch(e => { console.error(e); process.exit(1); });
        "
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}

    - name: Run tests
      run: pnpm test
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        OAUTH_SERVER_URL: ${{ secrets.OAUTH_SERVER_URL }}
        VITE_OAUTH_PORTAL_URL: ${{ secrets.VITE_OAUTH_PORTAL_URL }}
        VITE_APP_ID: ${{ secrets.VITE_APP_ID }}
        OWNER_OPEN_ID: ${{ secrets.OWNER_OPEN_ID }}
        OWNER_NAME: ${{ secrets.OWNER_NAME }}
        VITE_APP_TITLE: "DealFlow Network"
        VITE_APP_LOGO: "/logo.svg"
        BUILT_IN_FORGE_API_URL: ${{ secrets.BUILT_IN_FORGE_API_URL }}
        BUILT_IN_FORGE_API_KEY: ${{ secrets.BUILT_IN_FORGE_API_KEY }}
        VITE_FRONTEND_FORGE_API_URL: ${{ secrets.VITE_FRONTEND_FORGE_API_URL }}
        VITE_FRONTEND_FORGE_API_KEY: ${{ secrets.VITE_FRONTEND_FORGE_API_KEY }}
    
    - name: Build project
      run: pnpm build
      env:
        VITE_APP_TITLE: "DealFlow Network"
        VITE_APP_LOGO: "/logo.svg"
        VITE_OAUTH_PORTAL_URL: ${{ secrets.VITE_OAUTH_PORTAL_URL }}
        VITE_APP_ID: ${{ secrets.VITE_APP_ID }}
        VITE_FRONTEND_FORGE_API_URL: ${{ secrets.VITE_FRONTEND_FORGE_API_URL }}
        VITE_FRONTEND_FORGE_API_KEY: ${{ secrets.VITE_FRONTEND_FORGE_API_KEY }}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: |
          dist/
          .output/
        retention-days: 7
